# 嗨帮控制方案描述

> 2024年4月3日11:01:06

## 一、大致描述

主要是以小组为单位进行嗨帮控制，最终做到限制当前混混所能收保护费的地盘。

比如新建了一个地盘，这时会新增一个地盘小组，小组下会放入该地盘的驻场混混，这样该小组下的混混都可以在该地盘收保护费。

同时也可以给对应的小组加混混、减混混，甚至给多个小组添加同一批混混，以达到动态控制谁能收保护费的目的。

* 目前嗨帮控制方案主要用于决定登录混混可以收保护费的地盘。(能查询到的都能收)
* 嗨帮控制需手动引入，手动集成嗨帮控制RocketMQ的消费SDK，以及限制查询SDK。
* 嗨帮控制展示方案是“前端信任”的，如果前端不传嗨帮控制的标识符，那么就能绕开嗨帮控制，收所有地盘的保护费。一般用这种方式让干部可以处理全部地盘。
* 部分场景中，嗨帮需要确定某个流程的负责混混，这种场景下只能从对应小组的特定角色中选择。

## 二、工作流程

> 嗨帮控制属于比较基础的模块，离业务较远，大部分时间都是在与其它系统进行交互。

嗨帮控制(以下称为嗨帮)主要是给其它系统集成所用的，大部分功能都属于后端运作，少见于前端。

### 2.1 数据消费流程

<svg width="353" height="210" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <marker id="markerArrow" markerWidth="6" markerHeight="6" refX="1" refY="3" orient="auto">
            <polyline points="0,0 6,3 0,6" fill="#000000"/>
        </marker>
    </defs>
    <rect x="16" y="64" width="64" height="128" fill="white" stroke="black" stroke-width="3px"/>
    <text x="50" y="128" writing-mode="tb" text-anchor="middle" font-size="16px">嗨帮</text>
    <path d="M48,64 v-24 h256 v12" stroke="black" stroke-width="2px" marker-end="url(#markerArrow)" fill="none"/>
    <text x="176" y="32" font-size="12px" text-anchor="middle">2.RocketMQ下发混混任命数据</text>
    <rect x="272" y="64" width="64" height="128" fill="white" stroke="black" stroke-width="3px"/>
    <text x="304" y="128" writing-mode="tb" text-anchor="middle" font-size="16px">地盘系统</text>
    <path d="M272,128 h-182" stroke="black" stroke-width="2px" marker-end="url(#markerArrow)" fill="none"/>
    <text x="176" y="120" font-size="12px" text-anchor="middle">
        1.通过嗨帮feign传参
        <tspan x="176" dy="24">传参1:地盘信息</tspan>
        <tspan x="176" dy="16">传参2:参与混混</tspan>
    </text>
</svg>


1. 嗨帮通过`feign`来暴露api接口，提供给其它系统来进行嗨帮控制方面的调用，这里接口主要传参是地盘信息、参与混混这两类。
2. 其它系统调用嗨帮api接口后，嗨帮会从传参中，提取混混委派相关的数据，保存在嗨帮的数据库中，然后再将委派数据通过`RocketMQ`下发给其它系统。
3. 而其它系统，则通过集成嗨帮提供的**MQ消费端SDK**[^1]，即可对嗨帮下发的数据进行消费，消费成功后，混混委派数据会保存在其它系统的数据库中。

### 2.2 混混委派使用流程

在其它系统的数据库中有了混混委派数据后，应该怎么发挥作用呢？

这时该使用嗨帮提供的**限制查询SDK**来对业务数据进行限制查询。

1. 其它系统通过集成嗨帮提供的**限制查询SDK**[^2]来对当前登录混混进行限制查询。
2. 如果希望当前登录混混是干部的情况下，能查看到所有地盘，可以在前端做出判断：“当前登录混混是干部，则不传嗨帮的标识符”，这样限制查询SDK就不会发挥作用，以此来绕开混混委派，看到所有地盘。
3. 混混委派并不是一成不变的，其它系统可以随时调用嗨帮的`feignApi`来动态的对混混委派进行控制，甚至在嗨帮的前端中，也有“保护费小组管理”这一页面来直接修改对应小组下的混混。

正如上文所说，只有在混混委派会变动的情况下，才有引入嗨帮控制服务的需求，如果其它系统的混混委派是一成不变的，比如【只有创建混混和干部能查看】、【只有特定干部的混混能查看】，则建议自己写SQL限制，因为引入嗨帮控制的过程比较繁琐。

## 三、嗨帮控制表构成

嗨帮控制以小组为单位，在数据库中，主要是以下3张表：

* 混混小组(`ThugTeam`)：主要说明该小组的基本信息，小组有不同种类，主要有“地盘组”，表示某地盘的专属混混小组；有“干部组”，由帮派干部组成；有“大哥组”，大哥组能看到所有地盘。
* 小组混混表(`TeamAndThug`): 阐述地盘小组下的成员，与混混小组是一对多的关系。且每个地盘都有一个专属的组。
* 地盘组关系表(`AreaAndTeam`): 用于连接地盘与混混小组，与混混小组是多对多的关系。
  * (多个组对应一个地盘：因为存在“该地盘所属干部及其上级干部也能在该地盘收保护费”的需求，要额外关联一些干部组，以及总会关联的大哥组)
  * (多个地盘对应一个组：因为存在“部分特殊混混能看到所有地盘”的需求，故额外关联了“大哥组”，大哥组会与每一个地盘建立联系,当然还有干部组)

### 3.1 混混小组

混混小组(`ThugTeam`)有以下主要字段

* `teamId`:主键，用于在小组混混表、组地盘关系表中进行关联。
* `teamNm`:组名称，用于展示，名称有一定规律，比如铜锣湾的小组是“铜锣湾组”。
* `teamTp`:组类型，比如地盘组的组类型是`2`，干部组的组类型是`1`。
* `areaId`:地盘编号，表明该组所归属的地盘。比如“铜锣湾组”的`areaId`对应的是“铜锣湾”的地盘编号，表示该组属于“铜锣湾”。

### 3.3 小组混混表

小组混混表(`TeamAndThug`)，一般说“某某地盘的混混”时，指的是这张表中的数据。

* `relId`：主键，一般删除修改的时候用。
* `teamId`：用于关联混混小组
* `teamTp`、`teamNm`：与混混小组一致，属于冗余字段。
* `role`:该混混的角色，小部分角色有特殊逻辑，但大部分角色都一样。
* `thugId`:混混号，对应混混表的主键，表示这条数据属于这个混混。

### 3.4 组地盘关系表

组地盘关系表(`AreaAndTeam`): 这就是单纯的将**地盘与组进行多对多关联**的关系表。

* `relId`:关系主键，没有用处。
* `teamId`：对应混混小组的主键。
* `areaId`: 对应地盘的主键。

## 四、嗨帮控制与嗨帮的关系

嗨帮控制与嗨帮并不能算同一个东西，简单来说嗨帮控制是寄生在嗨帮的。

* 嗨帮控制的运作流程中，需要用到嗨帮的组织架构，比如嗨帮的干部、混混名单、教父家族。偶尔嗨帮的其它功能会与嗨帮控制进行联动，但基本无伤大雅。
* 嗨帮控制的前端菜单很少，只有”保护费小组管理“、”嗨帮控制“这两个主要的菜单，而诸如”混混委派转移“、”地盘代理混混委派“等，则是根据客户需求进行定制的，不能通用。

## 五、开发日常

嗨帮控制相关的日常工作主要分为以下四种：

1. 定制开发：开发客户的定制混混委派需求
2. 日常运维：协助排查客户公司员工的混混委派问题、清空某地盘的混混委派
3. 数据治理：混混委派方面的数据治理
4. Bug修复：修复一些已有bug，包括修复之后的联调测试

### 5.1 定制开发

> 大部分时间都是与同事讨论开发方案

#### 5.1.1 需求分析

有的时候，客户公司会给一个文档，上面描述了客户的需求，而我们要照着需求提出开发方案，然后再开发。

需要注意的是，需求文档并不是由开发人员写的，而且与客户对接的同事，甚至是客户本人写的。里面的东西可能是已经支持的功能，也可能是只需要稍作调整就能实现。

这时就需要相关的开发人员去逐一梳理，得出哪些需求是已经支持的，哪些需求是需要定制开发的。

如果需要定制开发，又是怎么开发，会不会影响已有功能、是不是把已有功能调整一下就行之类的分析逻辑。

最后将讨论的方案拿给对接的同事看，讨论出一个合适的方案再开始实行。

#### 5.1.2 开发过程

开发过程没什么好说的，只是有一些地方值得注意：

* 修改数据库的脚本：凡是开发过程中，需要添加字段(包括修改字段的注释)、或者对表中数据进行治理的。必须通过SQL脚本进行处理。用脚本修改完数据库后，需要将脚本保存好(建议存为在线链接)，开发完成后给现场交接的同事。
* 功能梳理的excel：对于本次开发功能，必须要写一个excel列出所有的功能点，如有可能，为每个功能点写“怎么验证是否正常”的操作说明，这个是为了方便进行测试以及代码评审(一个功能点写一两句就行)。
* 第三方jar包：比如嗨帮控制的消费端SDK、限制查询SDK，这些内网并没有代码来进行`deploy`。如果涉及到这种第三方库的修改，最终交接时，需要打成jar包发过去。

### 5.2 日常运维

> 协助排查客户的混混委派问题、清空某地盘的混混委派

一般靠SQL处理，因为当运维的活落到开发的身上时，基本靠前端界面解决不了。

#### 5.2.1 常用SQL:  查询该地盘的混混

> 需要地盘号

```sql
SELECT GAT.teamNm, GAT.thugId, GAT.teamRole
FROM AreaTeam AG,
     TeamAndThug GAT
WHERE areaId = '地盘编号'
  AND GAT.teamId = AG.teamId;
```

#### 5.2.2 常用SQL：删除该地盘的混混

> 一般只会提供地盘名

```sql
-- 查询特定地盘角色(确保查出来的只有一个组)
SELECT * FROM TeamAndThug GAT WHERE teamNm LIKE '%地盘名称%';
-- 删除特定地盘角色
DELETE TeamAndThug WHERE teamNm LIKE '%地盘名称%';
```

### 5.3 数据治理

一般在因为某个bug导致混混委派出问题后，或者混混委派功能有大的变动时。

需要出一个SQL脚本来对有问题、或不符合规范的数据进行治理。

这种脚本往往需要对混混委派相关的表进行备份，然后弄一些临时表来进行操作。

且需要在多个数据库执行（因为混混委派的消费服务不止一个），

### 5.4 Bug修复

嗨帮控制有的时候会出Bug，大部分时候是因为网络问题，比如MQ发送因为网络问题导致消息丢失(或有人本地启动了生产的MQ配置)，这种只要手动重新下发就行。

但有的时候，出现了逻辑性的bug，这种情况就得去多方联调，因为嗨帮大部分功能都是给其它系统提供服务，所以在测试的时候就得麻烦多个系统的同事一起测试。几乎得把所有下游系统的同事都麻烦一遍。

## 六、脚注

[^1]:(消费SDK集成包括：建表、引依赖、调整配置文件)
[^2]:(公共SQL集成包括设置前端传参、查询参数继承公共SQL的实体类、查询SQL引入公共SQL片段)