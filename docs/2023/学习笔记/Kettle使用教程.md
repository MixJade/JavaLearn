# Kettle使用教程

> 2024-09-05 15:48:48

Kettle是一个数据库迁移工具，似乎叫ETL类型工具

基础教程：[大数据ETL开发之图解Kettle工具-腾讯云开发者社区](https://cloud.tencent.com/developer/article/2037789)

## 一、建立资源库

点击菜单栏的【工具】-【资源库】-【连接资源库】-（点击加号新增）【选择文件类型的资源库】

---

* 以下是复制过来的资源库介绍，[原文链接](https://blog.csdn.net/u011046671/article/details/115756193)
* 常见的资源库有两种。为 文件资源库 和 数据库资源库。
* 文件资源库 是以 ktr 和 kjb 文件的形式（本质上是 xml 文件，可以使用文本工具打开查看编辑 ）保存在本地计算机的硬盘的目录中。
* 数据库资源库 是将脚本存放在数据库中，kettle 可以在常见的数据库中创建资源库。

---

* 文件资源库 将脚本保存在本地创建的目录中，打开资源库可以管理所有的脚本。可以解决在作业中引用其它脚本带来的路径问题，避免因不同平台（如Windows 和 Linux )中的路径分隔符不同，造成运行失败。因为脚本文件为文本文件，通过与其他版本管理工具（如 SVN 和 GIT ）配合，可以管理不同版本的脚本。但是因为脚本保存在本地计算机中，只能在本地运行，不能远程调用。
* 数据库资源库 将脚本保存数据库中，kettle 通过 JDBC 连接资源库，数据库可以是本地计算机，也可以是远程计算机。可以统一管理脚本。利用数据库备份工具可以对脚本进行备份，保证脚本的安全。数据库连接信息保存在数据库中，当信息变更的时候，在资源库【连接】标签中修改后，所有脚本使用的该数据库连接信息自动更新。
* 综上所述，我建议在有数据库的条件下，优先选择数据库资源库，在没有数据库的的情况下，选择文件资源库。或者在开发环境选择文件资源库，在生产环境选择数据库资源库。

## 二、连接数据库

* Oracle驱动下载地址(按自己的java版本下载，我下载的`ojdbc8.jar`)：[JDBC and UCP Downloads page (oracle.com)](https://www.oracle.com/database/technologies/appdev/jdbc-downloads.html)
* 数据库连接教程：[kettle连接oracle19c的3种方式-CSDN博客](https://blog.csdn.net/huryer/article/details/106414117)

---

1. 将下载的`ojdbc8.jar`放入`kettle`的文件夹：`\data-integration\lib`，重启`kettle`
2. 点击左侧菜单的【作业】-【DB连接】-【新建】
3. 我的数据库默认选中了Oracle，所以不需要改动
4. 在【数据库名称】处输入`地址+端口+数据库名`：`12.24.5.6:1521/my_db`
5. 清空它自带的【端口号】
6. 输入【用户名】和【密码】，这里可能看不到密码栏，在【用户名】栏按下tab键就能输入密码。(【密码】在【用户名】的下一个)
7. 点击【测试】，连接成功会有很明显的提示，如果[没有反应，就是驱动下错了](https://blog.csdn.net/qq_36703810/article/details/130145877)

## 三、测试：简单的导出表文件

> 可能在设置输出字段的那一步会报错**堆栈溢出**：[kettle中“获取字段”报StackOverflowError](https://blog.csdn.net/qq_40112386/article/details/87376198)

1. 新建一个【转换】，*注：在同一个资源库的作业、转换都可以在左上角的“文件夹”图标中点击查看*
2. 在【输入】中，拖拽【表输入】到画布上
3. 双击画布上的【表输入】组件，进行编辑，选择对应的【数据库链接】，然后选择【获取SQL查询语句】，将表输出的sql弄好
4. 在【输出】中，选择【excel输出】，拖拽到画布上
5. 将鼠标悬停在画布上【excel输出】，在浮现出的菜单选择最左边的“连线”，将线头拖到【表输入】上。**(注意：线必须是蓝色的，不能是灰色)**
6. 双击【excel输出】，在【文件】的【文件名】设置**输出的文件路径+文件名**，在【字段】处点击【获取字段】，这里会自动获取上一个【表输入】的字段。(可能会报错，这时去清理掉【表输入】中的“从步骤获取数据”)
7. 点击画布左上角的运行按钮，即可运行这个简单的转换。

## 四、在作业中使用转换

* 在实际使用时，往往是在作业中的某个步骤使用转换
* 关于如何通过目录管理/重命名作业、转换，只需要在【工具】-【探索资源库】中设置即可。
* 在作业画布中的【转换】，可以右键【Open Referenced Object】-【Teanform】打开对应的转换画布

---

1. 先选择【作业】
2. 从【通用】中拖拽一个【START】组件，一个【转换】组件，一个【成功】组件，并进行连接
3. 双击画布上的【转换】组件，选择【通过目录与名称指定转换】，选择之前设置的转换。
4. 或者不选之前的【转换】也行，在【转换】组件的左下角有【New Tranformed】按钮，可以新建一个，记得在新建时指定目录
5. 最后确定连线成功，点击运行即可

## 五、目录：贴源层

> 贴源层主要是把老数据库的数据给迁移至新数据库中。。
>
> 实现思路：保持与源数据库一致，且抽取的数据不直接做处理。
>

* 建议在资源库中新建一个目录，来表示这是在原数据库的操作。
* 如果在【表输出】那里的【数据库字段】-【获取字段】是灰的，请把【指定数据库字段】勾上
* 另外，在新数据库，可以通过kettle建立转换表:[kettle 创建表](https://blog.51cto.com/amadeus/9275503)

**管理须知：**

1. 这里一般都是一个作业多个转换，且转换都是**使用老系统表输入，使用新系统表输出**，目的是将老系统需迁移的表移至新系统中，方便之后的SQL映射。
2. 最好是提前建表，不然通过Kettle建表会没有字段注释。
3. 为了规范，新建的表*(贴源层)*都是ODS开头，中间加上来源数据库，比如在`Play`数据库的`Student`表，在新系统中是`ODS_Play_Student`

## 六、目录：转换层

> 转换层要处理贴源层的数据，进行数据转换
>
> 主要是存放中间表，或对源数据进行字典转换、设置日期格式、处理简单的字段映射

* 这里的表名以TFL开头，比如`Student`的中间表叫`TFL_Studnet`

* 这里的字典转换建议使用`Case-When`，如：

  ```sql
  UPDATE TFL_Studnet
  SET stu_type =
          CASE
              WHEN stu_type = 'D级人员' THEN 'D01'
              WHEN stu_type = 'D2级人员' THEN 'D02'
              WHEN stu_type = 'D3级人员' THEN 'D03'
              ELSE stu_type
              END;
  ```

## 七、目录：交付层

* 交付层与应用层结构一致，为应用层直接提供数据。
* 这里的表以`DEL_`开头，比如`DEL_Student`，其数据从转换层而来，在生成的过程中会加上主键。
* 这里应该只有将交付层的数据直接抽取进最终表的转换。

## 八、附录

Kettle的转换过程可以使用一个单独的数据库，该数据库包括了

1. kettle资源库
2. 贴源/转换/交付层的表，(直接在这个数据库中进行作业)