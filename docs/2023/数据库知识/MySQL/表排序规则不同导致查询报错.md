# 表排序规则不同导致查询报错

> 2025-12-24 16:42:06

## 问题描述

某天同步完数据库，查询页面报错：

```txt
org.springframework.jdbc.UncategorizedSQLException: 
### Error querying database.  Cause: java.sql.SQLException: Illegal mix of collations (utf8mb4_unicode_ci,IMPLICIT), (utf8mb4_general_ci,IMPLICIT)
### The error may exist in URL [jar:file:/data/ms-dog-2.5.0-SNAPSHOT.jar!/mapper/mysql/DogInfoMapper.xml]
### The error may involve defaultParameterMap
### The error occurred while setting parameters
### SQL: select di.dog_id, di.dog_name, fui.usr_nm as create_user_name from dog_info di left join f_user_info fui on fui.usr_no = di.create_user_no where di.use_state = '1' order by di.dog_id desc limit ?
```

## 问题分析

在使用以下SQL时出错（`join`的表字段`fui.usr_no`和`di.create_user_no`排序规则不一致所导致的）：

* 需要排查参与`join`的两表以及其下的两个字段，其排序规则一致

```sql
select di.dog_id, di.dog_name, fui.usr_nm as create_user_name
from dog_info di
         left join f_user_info fui on fui.usr_no = di.create_user_no
where di.use_state = '1'
order by di.dog_id desc
limit ?
```

## 问题解决

* 使用以下SQL查看各表、各表字段的排序规则：

```sql
-- 查看表的默认校对规则(Collation字段)
SHOW TABLE STATUS LIKE 'dog_info';
SHOW TABLE STATUS LIKE 'f_user_info';

-- 查看具体字段的校对规则(还是Collation字段)
SHOW FULL COLUMNS FROM dog_info LIKE 'create_user_no';
SHOW FULL COLUMNS FROM f_user_info LIKE 'usr_no';
```

* 这时查到`f_user_info`表排序规则为空
* 修改表的规则，建议统一使用`utf8mb4_general_ci`

```sql
-- 修改表的排序规则
ALTER TABLE f_user_info DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
```

* 然后又查到`f_user_info.usr_no`的排序规则为`utf8mb4_unicode_ci`
* 进行以下修改，让`f_user_info`的排序规则和`dog_info`一样都是`utf8mb4_general_ci`

```sql
-- 修改字段的排序规则(注意里面有一个字段类型长度，最好不要变动)
ALTER TABLE f_user_info MODIFY COLUMN USR_NO varchar(40) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
```

